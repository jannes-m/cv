%% Curriculum Vitae style file
%%
%% David LeBauer
%% Last updated: 30 March 2015
%%
%% This file contains elements from:
%%  - http://robjhyndman.com/research/cv.sty
%%  - http://kjhealy.github.com/kjh-vita
%%  - https://github.com/jkeirstead/jk-vita

%% ------------------------------------------------------------------------
%%  Load required packages
%%  ------------------------------------------------------------------------
\usepackage{paralist,ragged2e,datetime}
% If you want to use Helvetica (sansserif) throughout the text, uncomment the
% next two lines
%\usepackage{helvet}
%\renewcommand{\familydefault}{\sfdefault}

\usepackage{hyperref,fancyhdr,enumitem,color}
\usepackage[a4paper,centering]{geometry}
% change the width of the document margins
\usepackage{geometry}
 \geometry{
 a4paper,
 centering,
 left=40mm,
 right=25mm,
 }

\usepackage[compact,small,sf,bf]{titlesec}
\usepackage{marvosym}
\usepackage{fontawesome}
% Using Miktex the fontawesome symbols do not show, therefore you need to add a line of code
% http://tex.stackexchange.com/questions/265736/xelatex-fontawesome-compiles-without-errors-but-doesnt-show-symbols
\newfontfamily{\FA}{fontawesome.otf}
\usepackage{marginnote}%\reversemarginpar %marginnotes on left

%\usepackage{smallcaps}
%% ------------------------------------------------------------------------
%%  Git version tracking
%% ------------------------------------------------------------------------

%% If you don't use git or the vc package (from CTAN), comment this out.
%% If you comment it out, be sure to remove the \rfoot comment below, too.
%% See vc manual to compile with xelatex -enable-write18 vita
%%\immediate\write18{vc.sh}
%%\input{vc}

%% ------------------------------------------------------------------------
%% Fonts and colours
%% ------------------------------------------------------------------------
%% needed for xelatex to work
\usepackage{fontspec}
\usepackage{xunicode}

%% color for the links
\usepackage[usenames,dvipsnames]{xcolor}
% \definecolor{ImperialBlue}{rgb}{0.082,0.416,0.608}
% \definecolor{ImperialLightBlue}{rgb}{0.545,0.682,0.8}
\definecolor{MediumGray}{gray}{0.4}
%% Choose fonts for use with xelatex
%% Minion and Myriad are widely available, from Adobe.
%% Pragmata is available to buy at http://www.fsd.it/fonts/pragma.htm
%% and is worth every penny. Any good monospace font will work fine, though.
%% Consolas or inconsolata are good alternatives.
%\setromanfont[Mapping={tex-text},Numbers={OldStyle},Ligatures={Common}]{Times New Roman}% Minion Pro, Palatino
%\setsansfont[Mapping=tex-text,Colour=MediumGray]{FreeSans}
%\setmonofont[Mapping=tex-text,Scale=0.9]{FreeMono} % Consolas, Pragmata, Lucida Console

% \setmainfont[Mapping=tex-text,Numbers=OldStyle]{TeX Gyre Pagella}
% \setsansfont[Mapping=tex-text,Numbers=OldStyle,Scale=MatchLowercase]{TeX Gyre Heros}
% \setmonofont[Mapping=tex-text,Scale=MatchLowercase]{Inconsolata}

% http://tex.stackexchange.com/a/43627/1783
%\setromanfont[Ligatures=TeX]{TeX Gyre Pagella}
%\setsansfont[Ligatures=TeX,Colour=MediumGray]{TeX Gyre Heros}
%\setmonofont[Scale=MatchLowercase]{Inconsolata}

% match old cv
% http://tex.stackexchange.com/a/43627/1783
% \setmainfont[Ligatures={Common}, Numbers={OldStyle}]{Fontin}
% \setsansfont{Fontin Sans}
%% ------------------------------------------------------------------------
%% Header and footer
%% ------------------------------------------------------------------------

% git revision info inserted via external script -- see docs for vc
% package for details. comment out this line if you're not using vc,
% and also remove the \input{vc} line above.
% \newcommand{\gitinfo}{\textcolor{Gray}{\texttt{\scriptsize \VCRevision\ on \VCDateTEX}}}

% Style for the front page
\fancypagestyle{myplain}{%
  \fancyhf{}
  \renewcommand\headrulewidth{0pt}
  \renewcommand\footrulewidth{0pt}
%  \fancyfoot[R]{\gitinfo}
}

% Style for the other pages
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}
\fancyhead{}
\fancyfoot{}
% where do you want the pagenumber (header or footer?)
%\rhead{{\scriptsize\thepage}}
\rfoot{{\scriptsize\thepage}}
% \rfoot{\gitinfo}


%%------------------------------------------------------------------------
%% Basic name functions and title box
%%------------------------------------------------------------------------

%% used below in the hyperref declaration and address banner section.
\def\title#1{\def\@title{#1}}
\def\name#1{\def\@name{#1}}
\def\www#1{\def\@www{#1}}
\def\email#1{\def\@email{#1}}
\def\tel#1{\def\@tel{#1}}
\def\postnoms#1{\def\@postnoms{#1}}
\def\address#1{\def\@address{#1}}
\def\subject#1{\def\@subject{#1}}

%% Date format (if you wanted to include the date but you'll see below
%% I just use the version control info instead
% \newdateformat{rjh}{\monthname~\THEYEAR}
% \rjh
\date{} % not used (revision control instead)

%% hyperlinks
\AtBeginDocument{%
  \def\keywords{\@name, Vita, CV, Resume, \@subject}
  \hypersetup{xetex,
%    colorlinks=false,
%    urlcolor=White,
    hidelinks,
    plainpages=false,
    pdfpagelabels,
    bookmarksnumbered,
    pdftitle={Vita},
    pagebackref,
    pdfauthor={\@name},
    pdfkeywords={\keywords}
  }
}

\def\maketitle{
  \thispagestyle{myplain}

  % Pull header block up
  %\vspace*{-13em}
  \vspace*{-6em}
  \bigskip

% uncomment if you want your address to appear in the upper right corner
  \begin{minipage}[t]{3.6in}
    \flushright{\footnotesize \@address}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{2in}
    \flushright \footnotesize   \@tel \ \faPhone \\
    {\footnotesize   \texttt{\@email} \ \faEnvelope}  \\
    {\footnotesize   \texttt{\@www} \ \faGlobe}
  \end{minipage}

  %% Name
  \flushleft{\Large\scshape{\@title\ \@name}}\\
% photo picture
%  \begin{figure}
%  \flushright{
%    \includegraphics[width = 0.25\textwidth]{C:/Users/pi37pat/Desktop/pic.jpg}
%    }
%  \end{figure}
}

%%------------------------------------------------------------------------
%% Section styling
%%------------------------------------------------------------------------

%% This includes a fudge from the following link in order to get the
%% subsection to align with a section
%% http://tex.stackexchange.com/questions/19200/titlesec-remove-space-after-empty-margin-section

\makeatletter
\newif\ifaftersec\aftersecfalse

\newcommand\setsubskip{%
    \global\aftersectrue
    \everypar{%
        \global\aftersecfalse
        \if@noskipsec
            \global\@noskipsecfalse
            \clubpenalty\@M
            \hskip-\parindent
            \begingroup
                \@svsechd\unskip{\hspace{\@tempskipb}}%
            \endgroup
        \else
            \clubpenalty\@clubpenalty\everypar{}%
        \fi}}

\newcommand\subskip{%
  \ifaftersec
     \removelastskip%         EDIT 2
     \vspace{-\baselineskip}% EDIT 2 ??????????????
  \fi
  \global\aftersecfalse}

% Section styling
\titleformat{\section}[leftmargin]{\raggedleft\sffamily}{}{0pt}{}[\setsubskip]
\titlespacing*{\section}{2cm}{2.5ex}{0.5cm}

% Subsection styling
\titleformat{\subsection}{\subskip\slshape}{}{}{}[]
\titlespacing*{\subsection}{0pt}{2ex}{1ex}
\raggedbottom
\makeatother

%% ------------------------------------------------------------------------
%%   Bibliography formatting
%% ------------------------------------------------------------------------
%% documentation:
%% http://ctan.mirrorcatalogs.com/macros/latex/exptl/biblatex/doc/biblatex.pdf
\usepackage[
 sorting = ydnt,%rev. chronological; use ynt for chronological
 style = authoryear,
 natbib = true,
 defernumbers = true,
 maxnames = 20,
 firstinits = true,
 uniquename = init,
 dashed = false,
 doi = true,
 isbn = false,
 backend = biber]{biblatex}

\DeclareFieldFormat{url}{\url{#1}}
\DeclareFieldFormat[article]{pages}{#1}
\DeclareFieldFormat[inproceedings]{pages}{\lowercase{pp.}#1}
\DeclareFieldFormat[incollection]{pages}{\lowercase{pp.}#1}
\DeclareFieldFormat[article]{volume}{\mkbibbold{#1}}
\DeclareFieldFormat[article]{number}{\mkbibparens{#1}}
\DeclareFieldFormat[article]{title}{\MakeCapital{#1}}
\DeclareFieldFormat[article]{url}{}
\DeclareFieldFormat[inproceedings]{title}{#1}
\DeclareFieldFormat{shorthandwidth}{#1}
\DeclareFieldFormat{extrayear}{}

% No dot before number of articles
\usepackage{xpatch}
\xpatchbibmacro{volume+number+eid}{\setunit*{\adddot}}{}{}{}

% Remove In: for an article.
\renewbibmacro{in:}{%
  \ifentrytype{article}{}{%
  \printtext{\bibstring{in}\intitlepunct}}}

% Bibliography categories
\def\makebibcategory#1#2{\DeclareBibliographyCategory{#1}\defbibheading{#1}{\subsection*{#2}}}
\makebibcategory{monographs}{Monograph}
\makebibcategory{books}{Books}
\makebibcategory{papers}{Journal articles}
\makebibcategory{inpress}{in press}
\makebibcategory{chapters}{Book chapter}
\makebibcategory{conferences}{Conference Proceedings}
\makebibcategory{software}{Software}
\makebibcategory{techreports}{Unpublished working papers}
\makebibcategory{bookreviews}{Book reviews}
\makebibcategory{editorials}{Editorials}
\makebibcategory{phd}{PhD thesis}
\makebibcategory{subpapers}{Submitted}
\makebibcategory{curpapers}{Current projects}
\makebibcategory{other}{Reviews, software \& other writing}


\setlength{\bibitemsep}{2.5pt}
\setlength{\bibhang}{.4cm}

%\renewcommand*{\bibitem}{\item \mbox{} \\}
%\defbibenvironment{bibliography}
%{\list{}
%  {\setlength{\leftmargin}{\bibhang}%
%   \setlength{\itemsep}{\bibitemsep}%
%   \setlength{\parsep}{\bibparsep}}}
%{\endlist}
%{\bibitem}

\newenvironment{publications}{\section{Publications}}

\def\printbib#1{\printbibliography[category=#1,heading=#1]}
%\renewcommand{\bibfont}{\normalfont\fontsize{11}{13.4}\rmfamily}

% Add all papers in the bib file.
\nocite{*}

%%%------------------------------------------------------------------------
%%% Local commands
%%%------------------------------------------------------------------------
%% No bullets on labels
\renewcommand{\labelitemi}{~}

%% Custom hanging indent for vita items
\def\ind{\hangindent=1 true cm\hangafter=1 \noindent}
\def\labelitemi{~}
\renewcommand{\labelitemii}{~}

%%%------------------------------------------------------------------------
%% Geometry stuff
%%%------------------------------------------------------------------------

% This command allows hyphenation, where \raggedright does not
\RaggedRight
\sloppy

% Miscellaneous dimensions
\setlength{\parskip}{0ex}
\setlength{\parindent}{0em}
\setlength{\headheight}{15pt}
\setlength{\tabcolsep}{0.15cm}
\clubpenalty = 10000
\widowpenalty = 10000
\setlist{itemsep=1pt}
\setdescription{labelwidth=1.2cm,leftmargin=1.5cm,labelindent=1.5cm,font=\rm}

% Make Author bold
% maybe I have added this. Anyways I had to change the code again because
% biblatex 3.3 did not work with the old version, see also:
% http://tex.stackexchange.com/a/211821/1783
\newcommand{\makeauthorbold}[1]{%
  \DeclareNameFormat{author}{%
    \ifthenelse{\value{listcount}=1}
    {%
      {\expandafter\ifstrequal\expandafter{\namepartfamily}{#1}{\mkbibbold{\namepartfamily\addcomma\addspace \namepartgiveni}}{\namepartfamily\addcomma\addspace \namepartgiveni}}
      %
    }{\ifnumless{\value{listcount}}{\value{liststop}}
        {\expandafter\ifstrequal\expandafter{\namepartfamily}{#1}{\mkbibbold{\addcomma\addspace \namepartfamily\addcomma\addspace \namepartgiveni}}{\addcomma\addspace \namepartfamily\addcomma\addspace \namepartgiveni}}
        {\expandafter\ifstrequal\expandafter{\namepartfamily}{#1}{\mkbibbold{\addcomma\addspace \namepartfamily\addcomma\addspace \namepartgiveni\addcomma\isdot}}{\addcomma\addspace \namepartfamily\addcomma\addspace \namepartgiveni\addcomma\isdot}}%
      }
    \ifthenelse{\value{listcount}<\value{liststop}}
    {\addcomma\space}
  }
}
